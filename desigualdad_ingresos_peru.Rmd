---
title: "Desigualdades estructurales en el ingreso mensual: Un análisis multidimensional a nivel provincial en el Perú"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    css: estilo.css
runtime: shiny
    
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(ggplot2)
library(RColorBrewer)
library(readr)
library(rio)
library(dplyr)
library(cluster)
library(factoextra)
library(leaflet)
library(sf)
library(stringi)
library(knitr)

limpiar_nombres <- function(x) {
  x <- toupper(x)
  x <- stri_trans_general(x, "Latin-ASCII")
  x <- gsub("[^A-Z ]", "", x)
  x <- trimws(x)
  return(x)
}

colores_set2 <- brewer.pal(n = 8, name = "Set2")

mergesupreme1 <- read_csv("datafmergesupreme.csv")
mergesupreme_sin_influyentes <- read_csv("mergesupremesininflu.csv")
```

Introducción {data-icon="fa-chart-bar"}
=======================================================================
Column izquierda {data-width=500}
-----------------------------------------------------------------------
Descripción del estudio

### **Tema de investigación** 
El efecto del nivel educativo, la lengua materna, las limitaciones físicas y cognitivas, el estado de salud y el tipo de empleo en el ingreso percibido por la población adulta en Perú.

### **Pregunta de investigación** 
¿En qué medida el nivel educativo, el empleo formal y las limitaciones físicas y cognitivas, la lengua materna y el estado de salud influyen en el ingreso de las personas, considerando las condiciones socioeconómicas y agrupandolas por Provincia?

### **Justificación** 
La presente investigación busca analizar los factores que inciden en los ingresos mensuales en Perú, partiendo de la hipótesis de que el empleo formal, el acceso a Internet y su uso educativo se asocian positivamente con mayores ingresos. Esto se fundamente en literatura que destaca la importancia de la conectividad para la inclusión y el desarrollo de habilidades (CEPAL,2021). Asimismo, se vuelve a recalcar las brechas de género estructurales en la región (OIT, 2020) y la valoración de la experiencia laboral acumulada. Sin embargo, un punto central de esta investigación es el desafío que plante a la teoría tradicional que propone una mayor educación se relaciona directamente con más ingresos, en la práctica no siempre es así, especialmente en Perú.

### **Hipotesis**
Las personas con empleo formal, acceso a Internet y uso educativo de este recurso presentan mayores ingresos mensuales. Asimismo, los hombres y las personas mayores tienden a percibir ingresos superiores. Sin embargo, el efecto del nivel educativo no sigue una lógica lineal, y en algunos casos, las personas con educación inicial completa pueden superar en ingresos a aquellas con educación superior.

Column {data-width=500 .tabset}
-----------------------------------------------------------------------

```{r}
#| out.width: "100%"
#| fig.align: "center"

# URL de la imagen de LinkedIn
imagen_url <- "https://media.licdn.com/dms/image/v2/D4E22AQFGHCUNZqgUbw/feedshare-shrink_800/feedshare-shrink_800/0/1681836871132?e=1754524800&v=beta&t=BqO_F2BbyvMgR0nYR9_I_GJfq6sZWngyRK7gpa686DE"

# Mostrar imagen
knitr::include_graphics(imagen_url)
```

Variable dependiente  {data-icon="fa-chart-bar"}
=======================================================================

Column {data-width=500 .tabset}
-----------------------------------------------------------------------
Gráficos de Ingreso Total

### Ingreso Total Mensual
```{r}
ggplot(mergesupreme1, aes(x = Ingreso_total_combinado)) +
  geom_histogram(bins = 30, fill = "#56B4E9", color = "black", alpha = 0.8) +
  labs(
    title = "Distribución de Ingreso Total (Original)",
    subtitle = "Fuente: ENAHO 2023",
    x = "Ingreso Total",
    y = "Frecuencia"
  ) +
  theme_minimal(base_size = 14)
```

### Ingreso Total Mensual (log)
```{r}
ggplot(mergesupreme_sin_influyentes, aes(x = log(Ingreso_total_combinado))) +
  geom_histogram(bins = 30, fill = "#E69F00", color = "black", alpha = 0.85) +
  labs(
    title = "Distribución de log(Ingreso Total)",
    subtitle = "Fuente: ENAHO 2023",
    x = "log(Ingreso Total)",
    y = "Frecuencia"
  ) +
  theme_minimal(base_size = 14)
```


Column {data-width=500}
-----------------------------------------------------------------------

### Resumen Estadístico {.no-padding}

```{r}
summary(mergesupreme1$Ingreso_total_combinado)
```

Los datos revelan una marcada desigualdad en la distribución de ingresos. La gran diferencia entre la media (S/63,586) y la mediana (S/186) muestra una fuerte asimetría, donde unos pocos hogares tienen ingresos muy altos, mientras la mayoría reporta valores bajos o incluso cero.  Un hallazgo importante es que el 25% de los hogares declara ingresos iguales a cero, lo que podría deberse a:

Alta informalidad laboral (trabajadores no registrados)

Desempleo o ingresos no monetarios (autoconsumo, trueque)

Limitaciones en la medición (dificultad para captar todos los ingresos)

La transformación logarítmica aplicada a los datos confirma que la  distribución no sigue un patrón normal (como una campana simétrica). Existe una concentración extrema, es decir  pocos hogares tienen ingresos muchísimo más altos que el resto. 

Estos resultados muestran una economía profundamente desigual, donde el crecimiento beneficia desproporcionadamente a un pequeño grupo


Variables independientes y de control  {data-icon="fa-table"}
=======================================================================

Column {data-width=650 .tabset}
-----------------------------------------------------------------------

Gráficos de las variables independientes y de control

### Nivel educativo {data-width=400}

```{r}
library(plotly)
mergesupreme1 %>%
  count(Nivel_Educ) %>%
  plot_ly(x = ~Nivel_Educ, y = ~n, type = "bar",
          marker = list(color = colores_set2)) %>%
  layout(title = "Nivel educativo",
         xaxis = list(title = ""),
         yaxis = list(title = "Frecuencia")) 
```

### Tipo de Empleo {data-width=400}


```{r}
mergesupreme1 %>%
  count(Tipo_empleo) %>%
  plot_ly(x = ~Tipo_empleo, y = ~n, type = "bar",
          marker = list(color = colores_set2)) %>%
  layout(title = "Empleo Formal",
         xaxis = list(title = ""),
         yaxis = list(title = "Frecuencia")) 
```

### Uso de Internet educativo {data-width=400}


```{r}
mergesupreme1 %>%
  count(InternetEduca) %>%
  plot_ly(x = ~InternetEduca, y = ~n, type = "bar",
          marker = list(color = colores_set2)) %>%
  layout(title = "Uso de internet para educación",
         xaxis = list(title = ""),
         yaxis = list(title = "Frecuencia")) 
```

### Institución Educativa {data-icon="fa-school"}

```{r}
mergesupreme1 %>%
  count(Institucion_educ) %>%
  plot_ly(x = ~Institucion_educ, y = ~n, type = "bar",
          marker = list(color = colores_set2)) %>%
  layout(title = "Última Institución Educativa",
         xaxis = list(title = ""),
         yaxis = list(title = "Frecuencia"))
```

###Lengua materna {data-icon="fa-language"}

```{r}
mergesupreme1 %>%
  count(Lengua) %>%
  plot_ly(x = ~Lengua, y = ~n, type = "bar",
          marker = list(color = colores_set2)) %>%
  layout(title = "Lengua Materna",
         xaxis = list(title = ""),
         yaxis = list(title = "Frecuencia"))
```

### Edad {data-icon="fa-user-clock"}

```{r}
# Crear un rango de edad
mergesupreme1 <- mergesupreme1 %>%
  mutate(Edad_rango = cut(Edad, 
                          breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 100),
                          labels = c("0-10", "11-20", "21-30", "31-40",
                                     "41-50", "51-60", "61-70", "71-80", "81-100"),
                          right = FALSE))

# Contar frecuencias
edad_data <- mergesupreme1 %>%
  count(Edad_rango)

# Generar colores con Set2
colores_set2 <- brewer.pal(n = length(levels(edad_data$Edad_rango)), "Set2")

# Gráfico con colores aplicados manualmente
plot_ly(edad_data, 
        x = ~Edad_rango, 
        y = ~n, 
        type = "bar",
        marker = list(color = colores_set2)) %>%
  layout(title = "Distribución por Rango de Edad",
         xaxis = list(title = "Rango de Edad"),
         yaxis = list(title = "Frecuencia"))


```

### Sexo {data-icon="fa-venus-mars"}

```{r}
mergesupreme1 %>%
  count(Sexo) %>%
  plot_ly(x = ~Sexo, y = ~n, type = "bar",
          marker = list(color = colores_set2)) %>%
  layout(title = "Distribución por Sexo",
         xaxis = list(title = ""),
         yaxis = list(title = "Frecuencia"))
```

Regresión Lineal Múltiple {data-icon="fa-table"}
=======================================================================

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------

### Modelo Lineal Original

En este primer modelo (m1) se puede observar que es significante debido a que su pvalor equivale a esta cifra: < 2.2e-16 y que por ende, se puede concluir que el nivel de al menos una o más de las variables independientes tienen efecto predictorio en el Ingreso total por mes de las personas censadas. Por otra parte, se puede observar que existe una posible tendencia a la no normalidad por la variabilidad de los residuos reflejada en el "Residual standard error", pues este equivale a 242600 on 86563 degrees of freedom. Por otra lado, este modelo no constituiría una gran ayuda en predecir a que "m1" presenta un r2 ajustado muy bajo, siendo de tan solo 4% aproximadamente, por lo que no ayudaría a inferir cuestiones sobre el ingreso.

```{r}
m1=lm(Ingreso_total_combinado~ Nivel_Educ+Tipo_empleo+UsoInternet+InternetEduca+LIMITACIONES+Edad+Sexo+Enfermedad_crónica+Lengua,data = mergesupreme1)
summary(m1)
```

### Modelo logarítmico mejorado

```{r}
modelo = lm(log1p(Ingreso_total_combinado) ~ Nivel_Educ + Tipo_empleo + 
               UsoInternet + InternetEduca + LIMITACIONES + Lengua + Edad + Sexo, data = mergesupreme1)
summary(modelo)
```
Es por ello que decidimos usar la funcion "log" para controlar dichos residuos que complicaban la predicción, cosa que es normal cuando se analizan ingresos, pues no tienden a ser uniformes. la siguiente regresión lineal múltiple "modelo". Por cuestiones de significancia para el modelo, encontramos que la variable independiende "malestar crónico" no era lo suficientemente significativa para afectar al ingreso, por lo que decidimos retirarla. Los resultados del modelo son los siguientes, el "Residual standard error" ha reducido, siendo ahora: 3.603 on 86565 degrees of freedom, mientras que el r2 cuadrado ajustado ha aumentado, permitiendo al modelo ahora explicar casi un 20% del ingreso, lo que constituye una mejora notable. Por último, la significancia del modelo en general no se vió afectada, sino que se mantuvo < 2.2e-16.

Coeficientes {data-icon="fa-table"}
=======================================================================

Column derecha {data-width=500}
-----------------------------------------------------------------------

Interpretación de coeficientes del modelo

De los coeficientes del modelo final elegido, hemos podido encontrar que ciertas variables tienen diferentes niveles de influencia comparados con lo que se esperaba.
los coeficientes afectan al modelo de la siguiente forma:
En el caso del nivel de educación, con respecto a la educación inicial y en niveles porcentuales, hemos encontrado que, contrario a la literatura revisada, haber completado el nivel intermedio y superior de la educación hace que una persona tenga menor, bajando 55% y 24% respectivamente.
Con respecto al tipo de empleo, el empleo formal representa la mayor cantidad de ingreso en promedio, superando a las personas que no tienen empleo y a las personas con empleos informales en 98% y 96% respectivamente.
El tener acceso al internet representa una mejoría con respecto a las personas que no lo tienen, pues las personas que si tienen acceso a internet gozan de un 148% más de ingreso percibido.
El no tener limitaciones, ya sean físicas o cognitivas representa en el ingreso un porcentaje positivo de 536% con respecto a las personas que si las padecen.
Por último, de acuerdo al modelo por cada año que cumple una persona percibirá 3% más de soles en ingreso.

```{r}
resultados_modelo=broom::tidy(modelo) %>%
  mutate(perc_change = (exp(estimate) - 1) * 100) %>%
  select(term, estimate, perc_change, std.error, p.value)
summary(resultados_modelo)
```

Column {.tabset data-width=500}
-----------------------------------------------------------------------
 Gráficos de dispersión del modelo 

### Gráfico 1
```{r}
plot(modelo,1)
```

### Gráfico 2
```{r}
plot(modelo,2)
```

### Gráfico 3 
```{r}
plot(modelo,3)
```

### Gráfico 4
```{r}
plot(modelo,4)
```


Comparación {data-icon="fa-table"}
=======================================================================
Column {.tabset data-width=500}
-----------------------------------------------------------------------

### Annova
En ambos modelos, es posible observar que las variables son muy significativas para explicar el ingreso total mensual, con excepción de las personas que tienen enfermedades crónicas, pues esta sería la unica variable que no aportaría nada.
```{r}
library(magrittr)
library(knitr)
tanova=anova(m1,modelo)
kable(tanova,
      caption = "Tabla ANOVA para comparar modelos")%>%kableExtra::kable_styling(full_width = FALSE)
```

Column {.tabset data-width=500}
-----------------------------------------------------------------------
### AIC/BIC
Debido a que el modelo posterior "modelo" tiene menor AIC y BIC que el primer modelo "m1" dados sus coeficientes AIC de modelo: 467,658.4 frente a 2,392,643 (m1), BIC de modelo: 467,780.2 frente a 2,392,775 (m1), a pesar de que no haya habido una gran diferencia, la significancia de todas las variables en el "modelo" nos permite tomar esta decisión

```{r}
AIC(m1)
AIC(modelo)
BIC(m1)
BIC(modelo)
```


Análsis conglomerado {data-icon="fa-table"}
=======================================================================

```{r}
media_por_provincia <- mergesupreme1 %>%
  mutate(provincia = limpiar_nombres(provincia)) %>%
  group_by(provincia) %>%
  summarise(
    Edad_promedio = mean(Edad, na.rm = TRUE),
    Ingreso_promedio = mean(Ingreso_total_combinado, na.rm = TRUE),
    .groups = "drop"
  )

moda_por_provincia <- mergesupreme1 %>%
  mutate(provincia = limpiar_nombres(provincia)) %>%
  group_by(provincia) %>%
  summarise(
    Moda_Enfermedad = names(which.max(table(Enfermedad_crónica))),
    Moda_Lengua = names(which.max(table(Lengua))),
    Moda_TipoContrato = names(which.max(table(Tipo_contrato))),
    Moda_Sexo = names(which.max(table(Sexo))),
    Moda_NivelEduc = names(which.max(table(Nivel_Educ))),
    Moda_TipoEmpleo = names(which.max(table(Tipo_empleo))),
    Moda_Limitaciones = names(which.max(table(LIMITACIONES))),
    .groups = "drop"
  )

dataClus_prov <- left_join(media_por_provincia, moda_por_provincia, by = "provincia") %>%
  mutate(
    Enfermedad_binaria = ifelse(Moda_Enfermedad == "Sí", 1, 0),  
    Sexo_binario = ifelse(Moda_Sexo == "Mujer", 1, 0),
    NivelEduc_Superior = ifelse(Moda_NivelEduc == "Superior", 1, 0),
    Lengua_Espanol = ifelse(Moda_Lengua == "Español", 1, 0),
    Tipo_contrato_bin = ifelse(Moda_TipoContrato == "Sin contrato", 1, 0) 
  ) %>%
  select(
    provincia, 
    Edad_promedio, 
    Ingreso_promedio,
    Enfermedad_binaria, 
    Sexo_binario,
    NivelEduc_Superior, 
    Lengua_Espanol, 
    Tipo_contrato_bin 
  )
vars_cluster <- dataClus_prov %>% select(-provincia)
vars_cluster_escalado <- scale(vars_cluster)
rownames(vars_cluster_escalado) <- dataClus_prov$provincia
```

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------

### Diagrama del Codo para Jerarquización 
```{r}
fviz_nbclust(vars_cluster_escalado, FUN = hcut, method = "wss") +
  geom_vline(xintercept = 3, linetype = 2, color = "red") +
  labs(
    title = "Diagrama de Codo para Clustering Jerárquico",
    x = "Número de Clústers", 
    y = "Suma de cuadrados intra-cluster (WSS)"
  ) +
  theme_minimal()
```

### Diagrama de silueta

```{r}
dist_matrix <- dist(vars_cluster_escalado)
hc <- hclust(dist_matrix, method = "ward.D2")
grupos_prov <- cutree(hc, k = 3)  
silueta <- silhouette(grupos_prov, dist_matrix)
```

```{r}
fviz_silhouette(silueta) +
  labs(
    title = "Gráfico de Silueta para 3 Clústers",
    x = "Provincias",
    y = "Ancho de Silueta"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2") +
  theme(axis.text.x = element_blank())

prov_cluster_df <- data.frame(
  provincia = names(grupos_prov),
  cluster = as.factor(grupos_prov),
  ancho_silueta = silueta[, 3]  
)
```

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------

Mapa de clusters
```{r}
# Asegúrate que este chunk esté dentro de ```{r}
provincias_sf <- st_read("LIM_PROVINCIAL_PERU_MIN.json", quiet = TRUE) %>%
  mutate(provincia = limpiar_nombres(NOMBPROV))

# Crear data_con_cluster si no existe
data_con_cluster <- left_join(dataClus_prov, prov_cluster_df, by = "provincia") %>%
  mutate(cluster_label = recode(as.character(cluster),
    "1" = "Alta exclusión y bajo ingreso",
    "2" = "Mediana integración",
    "3" = "Alta integración y mayor ingreso"
  ))

# Unión con shapefile
mapa_con_etiquetas <- left_join(provincias_sf, data_con_cluster, by = "provincia")

# Mapa interactivo
renderLeaflet({
  pal_cluster <- colorFactor(
    palette = c("#C7E9B4", "#41B6C4", "#225EA8"),
    domain = mapa_con_etiquetas$cluster_label
  )
  
  leaflet(mapa_con_etiquetas) %>%
    addProviderTiles("CartoDB.Positron") %>%
    addPolygons(
      fillColor = ~pal_cluster(cluster_label),
      color = "white",
      weight = 1,
      fillOpacity = 0.8,
      label = ~paste0(provincia, " - ", cluster_label),
      highlightOptions = highlightOptions(weight = 2, color = "black", bringToFront = TRUE)
    ) %>%
    addLegend(
      pal = pal_cluster,
      values = ~cluster_label,
      title = "Clúster de Provincias",
      position = "bottomright"
    )
})

```

Alta exclusión y bajo ingreso:
"Este grupo agrupa provincias con bajos niveles de desarrollo económico y acceso limitado a servicios básicos. Se recomienda priorizar políticas públicas focalizadas en estas zonas, como programas de inclusión social o inversión en infraestructura."

Alta integración y mayor ingreso:
"Corresponde a áreas urbanas o regiones con alta actividad económica (ej: Lima, Arequipa). Su dinamismo sugiere oportunidades para impulsar proyectos de innovación o atracción de inversiones."

Mediana integración:
"Provincias en transición, con potencial de mejora mediante estrategias de desarrollo regional que fortalezcan su conectividad y productividad."




